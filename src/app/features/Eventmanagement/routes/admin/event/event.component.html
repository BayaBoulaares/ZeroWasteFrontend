<div class="container mt-4">
  <!-- Enhanced Search Bar -->
  <div class="search-container mb-4">
    <div class="row">
      <div class="col-md-8 col-lg-6 mx-auto">
        <div class="menu-section search-menu-section">
          <div class="input-group search-input-group">
            <!-- Search input -->
            <input 
              type="text" 
              class="form-control search-input" 
              placeholder="Search by event name, description or menu..." 
              [(ngModel)]="searchTerm" 
              (keyup.enter)="searchEvents()"
              aria-label="Search events"
            >
            <!-- Button container for perfect alignment -->
            <div class="button-container d-flex align-items-center">
              <!-- Search button -->
              <button class="btn search-btn me-2" (click)="searchEvents()">
                <i class="bi bi-search" style="font-size: 1.5rem;"></i>
              </button>
              <!-- Voice search on the right -->
              <app-voice-search (searchQuery)="handleVoiceSearch($event)" class="green-voice-btn"></app-voice-search>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Loading State -->
  <div *ngIf="isLoading" class="text-center">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
  </div>

  <!-- Error State -->
  <div *ngIf="error" class="alert alert-danger" role="alert">
    {{ error }}
  </div>

  <!-- Current Events Section -->
  <div *ngIf="currentEvents.length > 0" class="mb-5">
    <h2 class="section-title mb-4">Happening Now</h2>
    <div class="row">
      <div *ngFor="let event of currentEvents" class="col-md-4 mb-4">
        <div class="card event-card h-100">
          <img [src]="getImageUrl(event.imagePath || '')" class="card-img-top" [alt]="event.title">
          <div class="card-body">
            <h5 class="card-title">{{ event.title }}</h5>
            <p class="card-text">{{ event.description }}</p>
            <div class="event-details">
              <div class="menu-section">
                <h6>{{ getPriceDisplay(event).menuName }}</h6>
              </div>
              <div class="price-section">
                <!-- Total discount badge -->
                <div class="discount-badges d-flex mb-2">
                  <div *ngIf="getPriceDisplay(event).hasDiscount" class="discount-badge ai-badge" [ngClass]="getPriceDisplay(event).badgeClass">
                    <i class="fas fa-tag me-1"></i>
                    {{ getPriceDisplay(event).discountPercentage }}% OFF
                  </div>
                </div>
                
                <div class="price-row">
                  <span class="price-label">Original Price:</span>
                  <span class="original-price">${{ getPriceDisplay(event).original }}</span>
                </div>
                <div class="price-row">
                  <span class="price-label">Discounted Price:</span>
                  <span class="current-price">${{ getPriceDisplay(event).discounted }}</span>
                </div>
                <div *ngIf="getPriceDisplay(event).hasDiscount" class="price-row">
                  <span class="price-label">You Save:</span>
                  <span class="savings">${{ getPriceDisplay(event).savings }}</span>
                </div>
                
                <!-- AI explanation -->
                <div *ngIf="getPriceDisplay(event).isAiDiscounted" class="ai-explanation mt-2 small" 
                     [ngClass]="{'text-success': +getPriceDisplay(event).discountPercentage > +(event.valeurRemise || 0), 'text-info': +getPriceDisplay(event).discountPercentage <= +(event.valeurRemise || 0)}">
                  <i class="fas fa-robot me-1"></i>
                  {{ getPriceDisplay(event).aiExplanation }}
                </div>
              </div>
              <div class="event-dates">
                <small class="text-muted">
                  <i class="fas fa-calendar"></i> 
                  {{ event.startDate | date:'mediumDate' }} - {{ event.endDate | date:'mediumDate' }}
                </small>
              </div>
              <div class="available-places mt-2">
                <i class="fas fa-users"></i> 
                <span [ngClass]="{'text-danger': getPlaces(event) <= 5, 'text-warning': getPlaces(event) > 5 && getPlaces(event) <= 10, 'text-success': getPlaces(event) > 10}">
                  <strong>{{ getPlaces(event) > 0 ? getPlaces(event) + ' places available' : 'No places available' }}</strong>
                </span>
              </div>
            </div>
          </div>
          <div class="card-footer">
            <button class="btn" 
                    (click)="registerForEvent(event)" 
                    [disabled]="getPlaces(event) <= 0"
                    [ngClass]="{'btn-primary': getPlaces(event) > 0, 'btn-danger': getPlaces(event) <= 0}">
              <i class="fas fa-ticket-alt me-1" *ngIf="getPlaces(event) > 0"></i>
              <i class="fas fa-ban me-1" *ngIf="getPlaces(event) <= 0"></i>
              {{ getPlaces(event) > 0 ? 'Register (' + getPlaces(event) + ' places left)' : 'Sold Out' }}
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Upcoming Events Section -->
  <div *ngIf="upcomingEvents.length > 0">
    <h2 class="section-title mb-4">Upcoming Events</h2>
    <div class="row">
      <div *ngFor="let event of upcomingEvents" class="col-md-4 mb-4">
        <div class="card event-card h-100">
          <img [src]="getImageUrl(event.imagePath || '')" class="card-img-top" [alt]="event.title">
          <div class="card-body">
            <h5 class="card-title">{{ event.title }}</h5>
            <p class="card-text">{{ event.description }}</p>
            <div class="event-details">
              <div class="menu-section">
                <h6>{{ getPriceDisplay(event).menuName }}</h6>
              </div>
              <div class="price-section">
                <!-- Total discount badge -->
                <div class="discount-badges d-flex mb-2">
                  <div *ngIf="getPriceDisplay(event).hasDiscount" class="discount-badge ai-badge" [ngClass]="getPriceDisplay(event).badgeClass">
                    <i class="fas fa-tag me-1"></i>
                    {{ getPriceDisplay(event).discountPercentage }}% OFF
                  </div>
                </div>
                
                <div class="price-row">
                  <span class="price-label">Original Price:</span>
                  <span class="original-price">${{ getPriceDisplay(event).original }}</span>
                </div>
                <div class="price-row">
                  <span class="price-label">Discounted Price:</span>
                  <span class="current-price">${{ getPriceDisplay(event).discounted }}</span>
                </div>
                <div *ngIf="getPriceDisplay(event).hasDiscount" class="price-row">
                  <span class="price-label">You Save:</span>
                  <span class="savings">${{ getPriceDisplay(event).savings }}</span>
                </div>
                
                <!-- AI explanation -->
                <div *ngIf="getPriceDisplay(event).isAiDiscounted" class="ai-explanation mt-2 small" 
                     [ngClass]="{'text-success': +getPriceDisplay(event).discountPercentage > +(event.valeurRemise || 0), 'text-info': +getPriceDisplay(event).discountPercentage <= +(event.valeurRemise || 0)}">
                  <i class="fas fa-robot me-1"></i>
                  {{ getPriceDisplay(event).aiExplanation }}
                </div>
              </div>
              <div class="event-dates">
                <small class="text-muted">
                  <i class="fas fa-calendar"></i> 
                  {{ event.startDate | date:'mediumDate' }} - {{ event.endDate | date:'mediumDate' }}
                </small>
                <div class="days-left">
                  <i class="fas fa-clock"></i> 
                  {{ calculateDaysLeft(event.endDate) }} days left
                </div>
              </div>
            </div>
          </div>
          <div class="card-footer">
            <button class="btn" 
                    (click)="registerForEvent(event)" 
                    [disabled]="getPlaces(event) <= 0"
                    [ngClass]="{'btn-primary': getPlaces(event) > 0, 'btn-danger': getPlaces(event) <= 0}">
              <i class="fas fa-ticket-alt me-1" *ngIf="getPlaces(event) > 0"></i>
              <i class="fas fa-ban me-1" *ngIf="getPlaces(event) <= 0"></i>
              {{ getPlaces(event) > 0 ? 'Register (' + getPlaces(event) + ' places left)' : 'Sold Out' }}
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- No Events Message -->
  <div *ngIf="!isLoading && events.length === 0" class="text-center">
    <p class="lead">No events found. Try adjusting your search or check back later.</p>
  </div>
</div>